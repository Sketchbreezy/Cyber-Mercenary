name: Security Scanning

on:
  push:
    branches: [main, master]
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday

env:
  PYTHON_VERSION: "3.12"

jobs:
  slither-analysis:
    name: Slither Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Slither
        run: |
          pip install slither-analyzer

      - name: Run Slither
        run: slither contracts/src/Escrow.sol --solc-remaps '@openzeppelin=contracts/lib/openzeppelin-contracts/contracts' --exclude-low 2>&1 || true

  bandit-security:
    name: Bandit Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Bandit
        run: pip install bandit

      - name: Run Bandit
        run: bandit -r agent/src/ -f txt -o bandit_report.txt

      - name: Upload Bandit report
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report
          path: bandit_report.txt

  safety-audit:
    name: Safety Dependency Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Safety
        run: pip install safety

      - name: Run Safety check
        run: safety check -r requirements.txt || true

  pip-audit:
    name: pip-audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install pip-audit
        run: pip install pip-audit

      - name: Run pip-audit
        run: pip-audit --path=. --format=summary || true

  dependency-check:
    name: OWASP Dependency Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'Cyber-Mercenary'
          format: 'HTML'
          out: 'dependency-check-report'
          path: '.'
          args: |
            --exclude 'contracts/lib/**'
            --exclude 'node_modules/**'
