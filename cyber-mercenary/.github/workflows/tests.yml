name: Cyber-Mercenary CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  MONAD_CHAIN_ID: 10143
  RPC_URL: https://monad-testnet.drpc.org

jobs:
  python-tests:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./agent
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[dev]
    
    - name: Install pytest-aiohttp for async testing
      run: pip install pytest-asyncio pytest-cov
    
    - name: Run Python unit tests
      run: |
        pytest ../tests/ -v --cov=src --cov-report=xml --cov-report=term-missing
    
    - name: Run Python integration tests
      run: |
        pytest ../tests/api/ -v
    
    - name: Upload coverage to Codecov
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: codecov/codecov-action@v4
      with:
        files: ./agent/coverage.xml
        fail_ci_if_error: false

  solidity-tests:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Foundry
      uses: foundry-rs/foundry-toolchain@v1
      with:
        version: nightly
    
    - name: Install dependencies
      run: forge install
    
    - name: Compile contracts
      run: forge build
    
    - name: Run Forge tests
      run: forge test --match-contract EscrowTest -vv
    
    - name: Run Slither static analysis
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: crytic/slither-action@v0.3.0
      with:
        slither-config: slither.config.json
        working-directory: .
    
    - name: Run Echidna fuzzing
      if: false  # Enable when Echidna is available
      uses: crytic/echidna-action@v0.2
      with:
        contract: Escrow
        workflow: contracts/test/Echidna.yaml

  api-integration:
    runs-on: ubuntu-latest
    needs: python-tests
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"
    
    - name: Install dependencies
      run: |
        pip install httpx pytest-asyncio
    
    - name: Start API server
      run: |
        cd agent
        python -c "
        import uvicorn
        from api.server import app
        uvicorn.run(app, host='127.0.0.1', port=8000)
        " &
        sleep 5
    
    - name: Run integration tests
      run: |
        pytest ../tests/api/ -v -k "integration"
        curl -s http://127.0.0.1:8000/health | python -c "import sys, json; d=json.load(sys.stdin); assert d['status']=='healthy'; print('Health check passed')"
    
    - name: Stop API server
      run: pkill -f "uvicorn.run(app"

  lint:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"
        cache: 'pip'
    
    - name: Install linting tools
      run: pip install black ruff
    
    - name: Check Python formatting with Black
      run: black --check --diff agent/src/
    
    - name: Lint Python with Ruff
      run: ruff check agent/src/
    
    - name: Check Solidity formatting
      run: |
        forge fmt --check contracts/src/

  security-scan:
    runs-on: ubuntu-latest
    needs: python-tests
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Run Bandit security scan
      uses: tschmidtb51/bandit-action@master
      with:
        path: "agent/src"
        level: "high"
    
    - name: Run Safety check
      uses: pyupio/safety-action@master
      with:
        key: ${{ secrets.SAFETY_API_TOKEN }}
        args: --full-report
    
    - name: Check for known vulnerabilities in dependencies
      run: |
        pip install pip-audit
        pip-audit

  deploy-staging:
    runs-on: ubuntu-latest
    needs: [python-tests, solidity-tests, api-integration]
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    environment: staging
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to staging
      run: |
        echo "Deploying to staging environment..."
        # Add deployment commands here
        echo "Staging deployment complete"

  deploy-production:
    runs-on: ubuntu-latest
    needs: [python-tests, solidity-tests, api-integration, lint, security-scan]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment: production
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to production
      run: |
        echo "Deploying to production environment..."
        # Add production deployment commands here
        echo "Production deployment complete"
